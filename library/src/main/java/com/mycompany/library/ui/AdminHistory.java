
package com.mycompany.library.ui;

import com.mycompany.library.model.BorrowRecord;
import com.mycompany.library.repository.BorrowRecordRepository;
import java.awt.Color;
import java.awt.Component;
import java.awt.event.ActionEvent;
import java.time.LocalDate;
import java.time.format.DateTimeFormatter;
import java.time.format.DateTimeParseException;
import java.util.List;
import javax.swing.JFrame;
import javax.swing.JLabel;
import javax.swing.JTable;
import javax.swing.SwingUtilities;
import javax.swing.table.DefaultTableModel;
import javax.swing.table.TableCellRenderer;
import javax.swing.table.TableColumn;

/**
 *
 * @author qian
 */
public class AdminHistory extends javax.swing.JFrame {

    private DefaultTableModel tableModel;
    private String userId;
    private String adminId;
    
    AdminHistory(String userId,String adminId) {
        this.userId = userId;
        this.adminId = adminId;
        initComponents();
        initializeUI();
        showBorrowHistory();
    }
    
    private void initializeUI() {
        setTitle("借閱紀錄");
        setDefaultCloseOperation(JFrame.EXIT_ON_CLOSE);
        setLocationRelativeTo(null);

        tableModel = (DefaultTableModel) borrowedList.getModel();
        
        // Add buttons to the table
        TableColumn returnColumn = borrowedList.getColumn("借閱狀態");
        returnColumn.setCellRenderer(new StatusRenderer());

        indexBtn.addActionListener((ActionEvent e) -> {
            openIndexFrame(adminId);
        });
    }
    
    // 顯示借閱清單
    private void showBorrowHistory() {
        BorrowRecordRepository borrowRecordRepository = new BorrowRecordRepository();
        List<BorrowRecord> borrowHistory = borrowRecordRepository.findBorrowHistoryByUserId(userId);

        DefaultTableModel model = (DefaultTableModel) borrowedList.getModel();
        for (BorrowRecord record : borrowHistory) {
            String returnText = record.isReturn() ? "借用中" : "已歸還";
            
            model.addRow(new Object[] {record.getBookId(), record.getTitle(), record.getAuthor(), record.getBorrowDate(), record.getReturnDate(), record.getFine(), returnText});
        }
    }
    
    
    // 在表格中顯示不同顏色的借閱狀態
    private class StatusRenderer extends JLabel implements TableCellRenderer {

        public StatusRenderer() {
            setOpaque(true); // 設置為不透明
        }

        @Override
        public Component getTableCellRendererComponent(JTable table, Object value, boolean isSelected, boolean hasFocus, int row, int column) {
            String status = (String) value;
            String returnDateStr = (String) table.getValueAt(row, 4);
            DateTimeFormatter formatter = DateTimeFormatter.ofPattern("yyyy-MM-dd");

            try {
                LocalDate returnDate = LocalDate.parse(returnDateStr, formatter);
                LocalDate today = LocalDate.now();

                if ("已歸還".equals(status)) {
                    setText("已歸還");
                    setForeground(Color.BLACK);
                } else if (returnDate.isBefore(today)) {
                    setText("已過期");
                    setForeground(Color.RED);
                } else {
                    setText("借閱中");
                    Color darkerGreen = new Color(0, 128, 0);
                    setForeground(darkerGreen);
                }
            } catch (DateTimeParseException e) {
                e.printStackTrace();
                setText("未知狀態");
                setForeground(Color.GRAY);
            }

            return this;
        }
    }
    
    private void openIndexFrame(String adminId) {
        SwingUtilities.invokeLater(() -> {
            new AdminIndex(adminId).setVisible(true);
            
        });
        this.dispose(); // 关闭登录窗口
    }


    /**
     * This method is called from within the constructor to initialize the form.
     * WARNING: Do NOT modify this code. The content of this method is always
     * regenerated by the Form Editor.
     */
    @SuppressWarnings("unchecked")
    // <editor-fold defaultstate="collapsed" desc="Generated Code">//GEN-BEGIN:initComponents
    private void initComponents() {

        jScrollPane1 = new javax.swing.JScrollPane();
        borrowedList = new javax.swing.JTable();
        indexBtn = new javax.swing.JButton();

        setDefaultCloseOperation(javax.swing.WindowConstants.EXIT_ON_CLOSE);

        borrowedList.setModel(new javax.swing.table.DefaultTableModel(
            new Object [][] {

            },
            new String [] {
                "ID", "書名", "作者", "借閱時間", "到期時間", "罰金", "借閱狀態"
            }
        ));
        jScrollPane1.setViewportView(borrowedList);

        indexBtn.setText("回首頁");
        indexBtn.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                indexBtnActionPerformed(evt);
            }
        });

        javax.swing.GroupLayout layout = new javax.swing.GroupLayout(getContentPane());
        getContentPane().setLayout(layout);
        layout.setHorizontalGroup(
            layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(layout.createSequentialGroup()
                .addContainerGap()
                .addGroup(layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
                    .addComponent(indexBtn)
                    .addComponent(jScrollPane1, javax.swing.GroupLayout.PREFERRED_SIZE, 661, javax.swing.GroupLayout.PREFERRED_SIZE))
                .addContainerGap(197, Short.MAX_VALUE))
        );
        layout.setVerticalGroup(
            layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(javax.swing.GroupLayout.Alignment.TRAILING, layout.createSequentialGroup()
                .addContainerGap(60, Short.MAX_VALUE)
                .addComponent(indexBtn)
                .addGap(18, 18, 18)
                .addComponent(jScrollPane1, javax.swing.GroupLayout.PREFERRED_SIZE, 326, javax.swing.GroupLayout.PREFERRED_SIZE)
                .addGap(83, 83, 83))
        );

        pack();
    }// </editor-fold>//GEN-END:initComponents
    
    private void indexBtnActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_indexBtnActionPerformed
        // TODO add your handling code here:
    }//GEN-LAST:event_indexBtnActionPerformed

    /**
     * @param args the command line arguments
     */
    public static void main(String args[]) {
        // main 方法将不会被使用，因为我们直接从 index 跳转到 borrowedList
    }
    
    // 跳至index.java
   

    // Variables declaration - do not modify//GEN-BEGIN:variables
    private javax.swing.JTable borrowedList;
    private javax.swing.JButton indexBtn;
    private javax.swing.JScrollPane jScrollPane1;
    // End of variables declaration//GEN-END:variables

}
